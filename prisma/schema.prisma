// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  // NOTE : Si tu as des soucis d'import sur Vercel, enlève la ligne output pour laisser par défaut
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// 1. GESTION DES LIMITES & ABONNEMENTS (NOUVEAU)
// ==========================================

model UserApiLimit {
  id        String   @id @default(cuid())
  userId    String   @unique
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relation optionnelle si tu veux la cascade delete
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSubscription {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  stripeCustomerId       String?   @unique @map(name: "stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map(name: "stripe_subscription_id")
  stripePriceId          String?   @map(name: "stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map(name: "stripe_current_period_end")
  
  // Relation optionnelle
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// 2. DESIGN SYSTEM & ONTOLOGIE
// ==========================================

model Theme {
  id          String   @id @default(cuid())
  name        String   // Ex: "Swiss International", "Tech Unicorn"
  description String?  // Ex: "Minimaliste & Helvetica"
  color       String   // Code Hex pour la pastille UI (ex: #000000)
  
  // LE LIEN AVEC LE CODE
  baseLayout  String   // "swiss", "tech", "corporate"
  
  // CONFIGURATION VISUELLE
  config      Json     
  
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isSystem])
}

model ServiceTemplate {
  id          String   @id @default(cuid())
  category    String   
  subcategory String   
  title       String   
  
  salesCopy      Json   
  technicalScope Json   
  pricing        Json   
  marketContext  Json   

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([subcategory])
}

// ==========================================
// 3. UTILISATEURS & OFFRES
// ==========================================

model User {
  id        String    @id @default(cuid()) 
  email     String    @unique 
  
  // Identité Entreprise
  companyName    String?
  companyEmail   String?
  companyPhone   String?
  companyAddress String?
  companySiret   String?   
  companyWebsite String?   

  // Paramètres de Facturation
  quotePrefix    String    @default("DEV-")
  nextQuoteNumber Int      @default(1)
  defaultVatRate Float     @default(20.0)
  defaultTerms   String?   

  // Relations Métier
  Clients      Client[]
  Devis        Devis[]
  ServiceItems ServiceItem[]

  // Relations Système (NOUVEAU)
  apiLimit     UserApiLimit?
  subscription UserSubscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

model ServiceItem {
  id              String    @id @default(cuid())
  userId          String    
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title           String    
  description     String?   
  category        String?   
  
  unitPriceEuros  Float     
  defaultQuantity Float     @default(1) 
  isTaxable       Boolean   @default(true) 

  salesCopy       Json?     
  technicalScope  Json?     
  pricing         Json?     
  marketContext   Json?     

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@unique([userId, title]) 
  @@map("service_items")
}

// ==========================================
// 4. CRM & FACTURATION
// ==========================================

model Client {
  id        String    @id @default(cuid())
  userId    String    
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade) 

  name      String
  email     String?
  phone     String?   
  address   String?
  siret     String?   
  notes     String?   

  Devis     Devis[]   

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@unique([userId, name]) 
  @@map("clients")
}

model Devis {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  clientId    String    
  client      Client    @relation(fields: [clientId], references: [id])
  
  number      String    @unique
  issueDate   DateTime  
  
  status      String    @default("draft") 
  validityDate DateTime?

  totalTTC    Float     

  vatRatePercent      Float @default(20) 
  discountAmountEuros Float @default(0)  

  itemsData   Json      
  terms       String?   
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("devis")
}